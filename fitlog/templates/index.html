{% extends "base.html" %}
{% block title %}FitLog – Start{% endblock %}

{% block content %}
<div class="start-grid">
  <!-- Linke Spalte: Trainingspläne -->
  <section>
    <h2>Trainingspläne</h2>

    <!-- Listbox mit Plänen -->
    <select id="planList" size="8" class="listbox">
      {% for p in plans %}
        <option value="{{ p.id }}">{{ p.name }}</option>
      {% else %}
        <option disabled>(Noch keine Trainingspläne)</option>
      {% endfor %}
    </select>

    <!-- Buttonreihe: Löschen / Bearbeiten / Hinzufügen -->
    <div class="row gap">
      <button id="btnDelete"  type="button">Löschen</button>
      <button id="btnEdit"    type="button">Bearbeiten</button>
      <button id="btnAdd"     type="button">Hinzufügen</button>
    </div>
  </section>

  <!-- Rechte Spalte: Verlauf -->
  <section>
    <h2>Verlauf</h2>

    <div class="col gap">
      <button id="btnCalories" type="button">Verbrauchte Kalorien</button>
      <a class="btn" href="{{ url_for('progress.select_page') }}">Trainingsfortschritt</a>
    </div>

    <h3>Letztes Training:</h3>
    <div class="last-box">
      {% if last_session %}
        <div class="kv">
          <div>Datum:</div>         <div>{{ last_session.date }}</div>
          <div>Trainingsplan:</div> <div>{{ last_session.plan_name }}</div>
          <div>Dauer:</div>         <div>{{ last_session.duration_min }} min</div>
        </div>
      {% else %}
        <div class="kv">
          <div>Datum:</div>         <div>–</div>
          <div>Trainingsplan:</div> <div>–</div>
          <div>Dauer:</div>         <div>–</div>
        </div>
      {% endif %}
    </div>
  </section>
</div>

<!-- Großer Button unten zentriert -->
<div class="center">
  <button id="btnRecord" class="big" type="button" aria-disabled="true" disabled>
    Trainingsdaten erfassen
  </button>
</div>

<style>
  .start-grid{
    display:grid;
    grid-template-columns: 1fr 1fr;
    gap: 3rem;
    align-items:start;
  }
  @media (max-width: 900px){ .start-grid{ grid-template-columns:1fr; } }

  .listbox{
    width:100%;
    height:auto;
    min-height:210px;
    border:1px solid #bbb;
    background:#fff;
    padding:2px;
  }

  .row{ display:flex; }
  .col{ display:flex; flex-direction:column; }
  .gap{ gap:.6rem; margin-top:.6rem; }

  button{
    padding:.45rem .8rem;
    border:1px solid #bdbdbd;
    background:#efefef;
    cursor:pointer;
  }
  button:hover{ background:#e3e3e3; }

  .last-box{
    border:1px solid #000;
    padding:.5rem .6rem;
    margin-top:.4rem;
    background:#fff;
  }
  .kv{
    display:grid;
    grid-template-columns: 8rem 1fr;
    row-gap:.25rem;
    column-gap:.75rem;
    font-size:.95rem;
  }

  .center{ text-align:center; margin-top:2rem; }
  .big{
    padding:.9rem 2.2rem;
    border:1px solid #000;
    background:#efefef;
    font-size:1rem;
  }
</style>

<script>
  const list = document.getElementById('planList');
  const btnRecord = document.getElementById('btnRecord');
  const btnProgress = document.getElementById('btnProgress');
  const selId = () => (list && list.value ? list.value : null);

  function updateRecordButton() {
    const hasSel = !!selId();
    btnRecord.disabled = !hasSel;
    btnRecord.setAttribute('aria-disabled', String(!hasSel));
  }

  updateRecordButton();
  list && list.addEventListener('change', updateRecordButton);

  // Erfassen starten -> /sessions/new?plan_id=<id>
  btnRecord.addEventListener('click', () => {
    const id = selId();
    if (!id) return;
    window.location.href = "{{ url_for('sessions.new_session') }}" + "?plan_id=" + encodeURIComponent(id);
  });

  // Trainingsfortschritt -> /progress/plan/<id> (Matplotlib)
  btnProgress.addEventListener('click', () => {
    const id = selId();
    if (!id) return alert('Bitte einen Plan in der Liste auswählen.');
    window.location.href = "/progress/plan/" + encodeURIComponent(id);
  });

  // Bearbeiten -> /plans/<id>/edit
  document.getElementById('btnEdit').addEventListener('click', () => {
    const id = selId();
    if (!id) return alert('Bitte einen Plan in der Liste auswählen.');
    window.location.href = "{{ url_for('plans.edit_plan', plan_id=0) }}".replace('0', id);
  });

  // Löschen (Soft-Delete) -> POST /plans/<id>/delete
  document.getElementById('btnDelete').addEventListener('click', async () => {
    const id = selId();
    if (!id) return alert('Bitte einen Plan in der Liste auswählen.');
    if (!confirm('Diesen Plan wirklich archivieren (Soft-Delete)?')) return;
    try{
      const res = await fetch(`/plans/${id}/delete`, { method:'POST' });
      if(res.ok) location.reload();
      else alert('Löschen fehlgeschlagen.');
    }catch{ alert('Netzwerkfehler beim Löschen.'); }
  });

  // Hinzufügen -> Prompt für Namen -> POST /plans/create (next=/)
  document.getElementById('btnAdd').addEventListener('click', async () => {
    const name = (prompt('Name des neuen Plans:') || '').trim();
    if (!name) return;
    try{
      const form = new URLSearchParams({ name, next: "{{ url_for('home.index') if 'home' in g else url_for('index') }}" });
      const res = await fetch("{{ url_for('plans.create_plan') }}", {
        method:'POST',
        headers:{ 'Content-Type':'application/x-www-form-urlencoded' },
        body: form.toString()
      });
      if(res.redirected){ window.location.href = res.url; }
      else { location.reload(); }
    }catch{ alert('Anlegen fehlgeschlagen.'); }
  });
</script>
{% endblock %}
