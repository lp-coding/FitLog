{% extends "base.html" %}
{% block title %}FitLog – Der Fitnesstracker{% endblock %}

{% block content %}
<div class="grid">
  <!-- Linke Spalte: Trainingspläne -->
  <div class="card">
    <h3>Trainingspläne</h3>

    <form action="{{ url_for('plans.create_plan') }}" method="post" class="inline" aria-label="Neuen Trainingsplan anlegen">
      <input type="text" name="name" placeholder="Neuer Planname" required>
      <button class="btn">Hinzufügen</button>
    </form>

    <div>
      <!-- WICHTIG: Kein onchange-Redirect mehr – nur Auswahl! -->
      <select id="planSelect" class="listbox" size="10" aria-label="Vorhandene Trainingspläne">
        {% for p in plans %}
          <option value="{{ p.id }}">{{ p.name }}</option>
        {% endfor %}
      </select>

      <div class="btn-row" role="group" aria-label="Plan-Aktionen">
        <button id="deleteBtn" class="btn" disabled>Löschen</button>
        <button id="editBtn" class="btn" disabled="true">Bearbeiten</button>
        <a class="btn" href="{{ url_for('plans.list_plans_page') }}">Alle anzeigen</a>
      </div>
    </div>
  </div>

  <!-- Rechte Spalte: Verlauf + letztes Training -->
  <div class="card">
    <h3>Verlauf</h3>
    <div class="btn-col">
      <a class="btn" href="#" title="Kommt später">Verbrauchte Kalorien</a>
      <a class="btn" href="#" title="Kommt später">Trainingsfortschritt</a>
    </div>

    <h3 style="margin-top:1.25rem;">Letztes Training</h3>
    {% if last_session %}
      <table class="kv">
        <tr><td class="muted">Datum:</td><td>{{ last_session.started_at }}</td></tr>
        <tr><td class="muted">Trainingsplan:</td><td>{{ last_session.plan_name }}</td></tr>
        <tr>
          <td class="muted">Dauer:</td>
          <td>
            {% if last_session.ended_at %}
              {{ last_session.started_at }} – {{ last_session.ended_at }}
            {% else %}
              in Bearbeitung / Dauer folgt
            {% endif %}
          </td>
        </tr>
      </table>
    {% else %}
      <p class="muted">Noch keine Trainingseinheit erfasst.</p>
    {% endif %}
  </div>
</div>

<div class="full">
  <!-- Start-Button ist sichtbar und wird aktiv, sobald ein Plan selektiert ist -->
  <a id="startBtn" class="btn primary disabled" href="#" aria-disabled="true" title="Plan wählen, um zu starten">
    Trainingsdaten erfassen
  </a>
</div>

<!-- Kleines, pures JS: aktiviert Buttons erst bei Auswahl -->
<script>
document.addEventListener('DOMContentLoaded', function () {
  const select = document.getElementById('planSelect');
  const deleteBtn = document.getElementById('deleteBtn');
  const editBtn = document.getElementById('editBtn');
  const startBtn = document.getElementById('startBtn');

  function setEnabledButton(btn, enabled) {
    // Für <button>:
    if (btn.tagName === 'BUTTON') {
      btn.disabled = !enabled;
    }
    // Einheitliche A11y- & Style-Umschaltung:
    if (enabled) {
      btn.removeAttribute('aria-disabled');
      btn.classList.remove('disabled');
    } else {
      btn.setAttribute('aria-disabled', 'true');
      btn.classList.add('disabled');
    }
  }

  function updateActions() {
    const selectedId = select.value;
    const hasSelection = !!selectedId;

    setEnabledButton(deleteBtn, hasSelection);
    setEnabledButton(editBtn, hasSelection);

    // Start-Button (Anchor) aktivieren + Ziel setzen
    if (hasSelection) {
      startBtn.href = '/plans/' + selectedId;    // später: /sessions/start?plan_id=...
      startBtn.title = 'Training mit ausgewähltem Plan starten';
      setEnabledButton(startBtn, true);
    } else {
      startBtn.href = '#';
      startBtn.title = 'Plan wählen, um zu starten';
      setEnabledButton(startBtn, false);
    }
  }

  async function handleDelete() {
    const id = select.value;
    if (!id) return;
    const ok = confirm('Diesen Trainingsplan wirklich archivieren?');
    if (!ok) return;

    try {
        const res = await fetch(`/plans/${id}/delete`, { method: 'POST' });
        if (res.ok) {
          window.location.reload();
        } else {
          const data = await res.json().catch(() => ({}));
          alert(data.msg || 'Löschen/Archivieren fehlgeschlagen.');
        }
    } catch (e) {
    alert('Netzwerkfehler beim Löschen.');
    }
  }

  updateActions();                       // initialen Zustand setzen
  select.addEventListener('change', updateActions);
  deleteBtn.addEventListener('click', handleDelete);
});
</script>
{% endblock %}
